#!/bin/bash
set -euo pipefail

# Smoke test for Discourse - https://github.com/discourse/discourse

source "$(dirname "$0")/shared.sh"

macos_docker_reexec

setup_packages \
    libyaml-dev \
    libpq-dev \
    libxml2-dev \
    libxslt-dev \
    zlib1g-dev \
    libsqlite3-dev \
    pkg-config

setup_rv

[[ -d discourse ]] || git clone --depth 1 https://github.com/discourse/discourse.git
cd discourse

rv ci

# Check no gems are reinstalled
rv ci > output.txt && cat output.txt
grep -v "gems installed to" output.txt
grep "gems already installed in" output.txt

rv run bundle check

smoke_test_success "discourse"
